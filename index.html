# 리마 AI 리서처 - 버전 1 프로토타입
# 기능: 키워드 기반 영상 조사 → 자막/댓글/썸네일 분석 → 요약 결과 리턴

import os
import openai
import requests
import yt_dlp
from pytube import YouTube
from youtube_transcript_api import YouTubeTranscriptApi
from transformers import pipeline

openai.api_key = os.getenv("OPENAI_API_KEY")

# 감정 분석기 초기화
sentiment = pipeline("sentiment-analysis")

def search_youtube(keyword, max_results=3):
    search_url = f"https://www.googleapis.com/youtube/v3/search?part=snippet&q={keyword}&type=video&key={os.getenv('YOUTUBE_API_KEY')}&maxResults={max_results}"
    results = requests.get(search_url).json()
    return [(item['id']['videoId'], item['snippet']['title']) for item in results.get('items', [])]

def extract_transcript(video_id):
    try:
        transcript = YouTubeTranscriptApi.get_transcript(video_id, languages=['ko', 'en'])
        return " ".join([entry['text'] for entry in transcript])
    except:
        return "(자막 없음)"

def analyze_sentiment(text):
    result = sentiment(text[:512])
    return result[0]['label'], result[0]['score']

def generate_report(video_id, title):
    transcript = extract_transcript(video_id)
    label, score = analyze_sentiment(transcript)
    prompt = f"""
    다음은 유튜브 영상 자막 내용입니다:
    """
    {transcript}
    """
    위 내용을 요약하고, 장갑의 효과에 대해 긍정적인지 부정적인지 설명해줘.
    """
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": "당신은 유능한 당구 분석가입니다."},
            {"role": "user", "content": prompt}
        ]
    )
    return {
        "제목": title,
        "감정 분석": f"{label} ({round(score, 2)})",
        "요약": response['choices'][0]['message']['content']
    }

def rima_ai_research(keyword):
    videos = search_youtube(keyword)
    report = []
    for vid, title in videos:
        info = generate_report(vid, title)
        report.append(info)
    return report

# 실행 예시
if __name__ == "__main__":
    keyword = "당구 브릿지 장갑 효과"
    result = rima_ai_research(keyword)
    for r in result:
        print("---")
        for k, v in r.items():
            print(f"{k}: {v}")
