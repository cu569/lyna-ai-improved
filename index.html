from flask import Flask, jsonify, send_file
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
import os, time

VIDEO_PATH = r"C:\video\test.mp4"   # TODO: CLI 인자·환경변수화

app = Flask(__name__)

def get_driver():
    options = webdriver.ChromeOptions()
    options.add_argument(r'--user-data-dir=C:\selenium\profile')
    options.add_argument('--disable-gpu')
    return webdriver.Chrome(service=Service(ChromeDriverManager().install()),
                            options=options)

@app.route('/upload', methods=['POST'])
def upload():
    try:
        drv = get_driver()
        drv.get('https://studio.youtube.com/')
        # 이미 로그인된 세션이면 다음 줄이 바로 실행됨
        drv.find_element(By.XPATH, '//*[@id="create-icon"]').click()
        drv.find_element(By.XPATH, '//*[@data-title="Upload videos"]').click()
        time.sleep(2)
        drv.find_element(By.CSS_SELECTOR, 'input[type="file"]').send_keys(VIDEO_PATH)

        # 진행률 감시
        while True:
            try:
                bar = drv.find_element(By.CSS_SELECTOR, '#progress-bar')
                if bar.get_attribute('aria-valuenow') == '100':
                    break
            except Exception:
                pass
            time.sleep(5)

        url = drv.find_element(By.CSS_SELECTOR, 'a.ytcp-video-info').get_attribute('href')
        drv.quit()
        return jsonify(ok=True, url=url)
    except Exception as e:
        return jsonify(ok=False, error=str(e))
