# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ backend/app.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
from flask import Flask, jsonify, request
from flask_cors import CORS
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
import time, os, threading

app = Flask(__name__)
CORS(app)  # ë°ëª¨ ë‹¨ê³„ ì „ì²´ ë„ë©”ì¸ í—ˆìš©

# ì—…ë¡œë“œ ëŒ€ìƒ ì˜ìƒ (í™˜ê²½ë³€ìˆ˜Â·ìš”ì²­ bodyë¡œ ëŒ€ì²´ ê°€ëŠ¥)
VIDEO_PATH = os.getenv("VIDEO_PATH", r"C:\video\test.mp4")

# â”€â”€ ê°„ë‹¨í•œ ì¸ë©”ëª¨ë¦¬ DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rimas      = []          # [{id,name,leader(bool),approved(bool)}]
pending_id = 1
def new_rima(name):
    global pending_id
    rimas.append({"id": pending_id, "name":name, "leader":False, "approved":False})
    pending_id += 1
    return pending_id-1

# â”€â”€ Selenium ì—…ë¡œë“œ í•¨ìˆ˜ (ë³„ë„ ì“°ë ˆë“œ ì‹¤í–‰) â”€â”€â”€â”€â”€â”€
def _upload(video_path, result):
    try:
        options = webdriver.ChromeOptions()
        options.add_argument(r'--user-data-dir=C:\selenium\profile')
        drv = webdriver.Chrome(service=Service(ChromeDriverManager().install()),
                               options=options)
        drv.get('https://studio.youtube.com/')
        drv.find_element(By.XPATH, '//*[@id="create-icon"]').click()
        drv.find_element(By.XPATH, '//*[@data-title="Upload videos"]').click()
        time.sleep(2)
        drv.find_element(By.CSS_SELECTOR, 'input[type="file"]').send_keys(video_path)

        # ì§„í–‰ ìƒí™© í´ë§
        while True:
            try:
                bar = drv.find_element(By.CSS_SELECTOR, '#progress-bar')
                if bar.get_attribute('aria-valuenow') == '100':
                    break
            except Exception:
                pass
            time.sleep(5)

        url = drv.find_element(By.CSS_SELECTOR, 'a.ytcp-video-info').get_attribute('href')
        drv.quit()
        result["ok"]  = True
        result["url"] = url
    except Exception as e:
        result["ok"]   = False
        result["error"]= str(e)

# â”€â”€ REST API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@app.route('/rima', methods=['GET','POST'])
def rima_list_or_create():
    if request.method == 'POST':
        name = request.json.get('name','New Rima')
        rid  = new_rima(name)
        return jsonify(ok=True, id=rid)
    # GET
    leaders  = sum(1 for r in rimas if r["leader"])
    pendings = sum(1 for r in rimas if not r["approved"])
    return jsonify(list=rimas, leader=leaders, pending=pendings)

@app.route('/rima/<int:rid>/approve', methods=['POST'])
def rima_approve(rid):
    for r in rimas:
        if r["id"]==rid:
            r["approved"]=True
            r["leader"]=True if sum(x["leader"] for x in rimas)<10 else False
            return jsonify(ok=True)
    return jsonify(ok=False, error="ID not found"), 404

@app.route('/chat', methods=['POST'])
def chat():
    msg = request.json.get('msg','')
    reply = "GPT-ë¦¬ë§ˆ ì‘ë‹µ: " + msg[::-1]   # ë°ëª¨ìš©: ê±°ê¾¸ë¡œ ë°˜í™˜
    return jsonify(reply=reply)

@app.route('/upload', methods=['POST'])
def upload():
    result = {}
    threading.Thread(target=_upload, args=(VIDEO_PATH,result)).start()
    # ì¦‰ì‹œ ì‘ë‹µ: í´ë¼ì´ì–¸íŠ¸ì—ì„œ í´ë§ ë˜ëŠ” ì›¹ì†Œì¼“ ëŒ€ì²´ ê°€ëŠ¥
    return jsonify(ok=True, status="upload_started")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.getenv("PORT",8080)))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ backend/requirements.txt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Flask
flask-cors
selenium>=4.21
webdriver-manager

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ backend/Procfile (Renderâ€§Heroku ë“±) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
web: gunicorn app:app --bind 0.0.0.0:$PORT

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ frontend/index.html â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë¦¬ë§ˆ AI ë©”ì¸ ìƒí™©íŒ</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://unpkg.com/modern-css-reset/dist/reset.min.css" rel="stylesheet">
<style>
body{font-family:sans-serif;background:#e8edff;text-align:center;padding:2rem;}
h1{color:#4b4bff;margin-bottom:2rem;}
.grid{display:grid;grid-template-columns:repeat(2,160px);gap:1.5rem;justify-content:center;}
.card{background:#fff;border-radius:16px;padding:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,.08);cursor:pointer;}
.card small{display:block;color:#666;margin-top:.3rem;font-size:.8rem}
.badge{background:#4b4bff;color:#fff;border-radius:12px;padding:.2rem .6rem;font-size:.8rem}
#yt-links a{display:block;margin-top:.4rem;}
.modal{position:fixed;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;}
.modal>.box{background:#fff;border-radius:12px;padding:1.5rem;width:90%;max-width:380px;text-align:left;}
.modal.open{display:flex;}
</style>
</head>
<body>

<h1>ë¦¬ë§ˆ AI ë©”ì¸ ìƒí™©íŒ</h1>

<div class="grid">
  <div id="card-create"  class="card">âœ¨ ë¦¬ë§ˆ ìƒì„±/ê´€ë¦¬<small>ë¬´í•œ ìƒì„±</small></div>
  <div id="card-approve" class="card">ğŸ›¡ï¸ ë¦¬ë” ë¦¬ë§ˆ ìŠ¹ì¸<small>10ê°œ ì´ˆê³¼ ì‹œ ì§€ë¬¸ì¸ì¦</small></div>
  <div id="card-upload"  class="card">ğŸ¥ ìœ íŠœë¸Œ ì—…ë¡œë“œ<small>ìë™ ì‹¤í–‰</small></div>
  <div id="card-chat"    class="card">ğŸ’¬ ì±„íŒ…/ì•Œë¦¼/ë³´ê³ <small>ì‹¤ì‹œê°„ ëŒ€í™”</small></div>
</div>

<p style="margin-top:2rem">
  í˜„ì¬ ë¦¬ë” ë¦¬ë§ˆ: <span id="cnt" class="badge">0ê°œ</span> ï½œ ìŠ¹ì¸ëŒ€ê¸°: <span id="pending" class="badge">0ê±´</span>
</p>
<div id="yt-links"></div>

<!-- ì±„íŒ… ëª¨ë‹¬ -->
<div id="modal" class="modal">
  <div class="box">
    <h3>ğŸ’¬ ì±„íŒ…/ì•Œë¦¼/ë³´ê³ </h3>
    <div id="chatBox" style="height:160px;overflow-y:auto;border:1px solid #ccc;padding:.5rem;margin:.5rem 0;"></div>
    <input id="msg" placeholder="GPT+ë¦¬ë§ˆì—ê²Œ ëª…ë ¹ ì…ë ¥" style="width:100%;padding:.5rem">
    <button id="sendBtn" style="width:100%;padding:.6rem;margin-top:.5rem;background:#4b4bff;color:#fff;border:none;border-radius:8px;">ëª…ë ¹ ì „ì†¡</button>
  </div>
</div>

<script>
const API = "https://api.g911-rima.render.com";  // â˜… ë°°í¬ëœ ë°±ì—”ë“œ URL

const $ = s=>document.querySelector(s);

// ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
$("#card-create").onclick  = async ()=>{
  const name=prompt("ë¦¬ë§ˆ ì´ë¦„?"); if(!name)return;
  const r=await fetch(API+"/rima",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
  const j=await r.json();
  alert(j.ok?"ë¦¬ë§ˆ #"+j.id+" ìƒì„±":"ERROR");
  refreshCounts();
};
$("#card-approve").onclick = async ()=>{
  const id=prompt("ìŠ¹ì¸í•  ë¦¬ë§ˆ ID?"); if(!id)return;
  const r=await fetch(API+"/rima/"+id+"/approve",{method:"POST"});
  const j=await r.json();
  alert(j.ok?"ìŠ¹ì¸ ì™„ë£Œ":"ERROR: "+j.error);
  refreshCounts();
};
$("#card-upload").onclick  = async ()=>{
  alert("ì—…ë¡œë“œ ì‹œì‘â€¦");
  const r=await fetch(API+"/upload",{method:"POST"});
  const j=await r.json();
  if(j.ok){ alert("ì„œë²„ì—ì„œ ì—…ë¡œë“œ ì‹œì‘. ëª‡ ë¶„ ë’¤ ë§í¬ê°€ ë„ì°©í•©ë‹ˆë‹¤."); }
  else    { alert("ERROR: "+j.error); }
};
$("#card-chat").onclick = ()=>$("#modal").classList.add("open");
$("#modal").onclick = e=>{ if(e.target.id==="modal") $("#modal").classList.remove("open"); };

$("#sendBtn").onclick = async ()=>{
  const txt=$("#msg").value.trim(); if(!txt)return;
  $("#msg").value=""; addChat("ë‚˜",txt);
  const r=await fetch(API+"/chat",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({msg:txt})});
  const j=await r.json(); addChat("GPT",j.reply);
};
function addChat(who,msg){
  const p=document.createElement("p");
  p.innerHTML=`<b>[${who}]</b> ${msg}`;
  $("#chatBox").append(p); $("#chatBox").scrollTop = $("#chatBox").scrollHeight;
}
async function refreshCounts(){
  const r=await fetch(API+"/rima"); const j=await r.json();
  $("#cnt").textContent=j.leader+"ê°œ";
  $("#pending").textContent=j.pending+"ê±´";
}
refreshCounts();
</script>
</body>
</html>
