<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYNA AI - ì™„ì „ ìŒì„±+ì „í™” í†µí•© ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow-x: hidden;
        }

        .voice-assistant-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .voice-interface {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            width: 300px;
            height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 3rem;
            border: 5px solid rgba(255, 255, 255, 0.3);
            animation: voicePulse 1.5s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px rgba(102, 126, 234, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 50px rgba(102, 126, 234, 0.8); }
        }

        .voice-status {
            font-size: 1.2rem;
            margin-top: 1rem;
            text-align: center;
        }

        .floating-voice-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #ff4081, #9c27b0);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(255, 64, 129, 0.5);
            transition: all 0.3s ease;
            animation: floatingBob 2s ease-in-out infinite;
        }

        @keyframes floatingBob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .floating-voice-btn:hover {
            transform: scale(1.1);
        }

        .floating-voice-btn.listening {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            animation: listeningPulse 1s ease-in-out infinite;
        }

        @keyframes listeningPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 1); }
        }

        .floating-phone-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #28a745, #20c997);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.5);
            transition: all 0.3s ease;
            animation: floatingBob 2s ease-in-out infinite 0.5s;
        }

        .floating-phone-btn.calling {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            animation: phoneRing 0.5s ease-in-out infinite;
        }

        @keyframes phoneRing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            padding: 2rem;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 3px solid #667eea;
            position: relative;
        }

        .header h1 {
            color: #333;
            font-size: 3rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .voice-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 20px;
            padding: 2rem;
            border: 3px solid #dee2e6;
            transition: all 0.4s ease;
        }

        .control-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .panel-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .voice-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 1.2rem 2rem;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            margin: 0.5rem;
            width: 100%;
        }

        .voice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .voice-btn.active {
            background: linear-gradient(45deg, #4caf50, #8bc34a);
            animation: activeBtn 1.5s infinite;
        }

        @keyframes activeBtn {
            0%, 100% { box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 8px 25px rgba(76, 175, 80, 0.8); }
        }

        .phone-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .phone-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 1.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .phone-btn:hover {
            transform: scale(1.1);
        }

        .phone-btn.calling {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            animation: phoneActive 1s infinite;
        }

        @keyframes phoneActive {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .voice-visualization {
            height: 80px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .voice-bars {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .voice-bar {
            width: 4px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 2px;
            transition: height 0.1s ease;
        }

        .status-display {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .chat-container {
            background: rgba(248, 249, 250, 0.9);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid #dee2e6;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            border: 1px solid #e9ecef;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.6;
            animation: messageSlide 0.4s ease-out;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #333;
            border: 1px solid #dee2e6;
            margin-right: auto;
        }

        .voice-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
            background: white;
            padding: 1rem;
            border-radius: 15px;
            border: 2px solid #dee2e6;
        }

        #userInput {
            flex: 1;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1rem;
            outline: none;
        }

        .wake-word-settings {
            background: rgba(255, 193, 7, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 193, 7, 0.3);
        }

        .always-listening {
            background: rgba(76, 175, 80, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border: 2px solid rgba(76, 175, 80, 0.3);
            text-align: center;
        }

        .permission-request {
            background: rgba(255, 0, 0, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
            border: 2px solid rgba(255, 0, 0, 0.3);
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                width: 98%;
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .voice-controls {
                grid-template-columns: 1fr;
            }
            
            .floating-voice-btn, .floating-phone-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- ìŒì„± ì¸í„°í˜ì´ìŠ¤ ì˜¤ë²„ë ˆì´ -->
    <div class="voice-assistant-overlay" id="voiceOverlay">
        <div class="voice-interface">
            <div id="voiceIcon">ğŸ¤</div>
            <div class="voice-status" id="voiceStatusText">ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
    </div>

    <!-- í”Œë¡œíŒ… ìŒì„± ë²„íŠ¼ -->
    <button class="floating-voice-btn" id="floatingVoiceBtn" onclick="toggleVoiceAssistant()">ğŸ¤</button>
    
    <!-- í”Œë¡œíŒ… ì „í™” ë²„íŠ¼ -->
    <button class="floating-phone-btn" id="floatingPhoneBtn" onclick="togglePhoneCall()">ğŸ“</button>

    <div class="container">
        <div class="header">
            <h1>ğŸ¤ LYNA AI</h1>
            <p>ì™„ì „ ìŒì„±+ì „í™” í†µí•© ì‹œìŠ¤í…œ</p>
        </div>

        <div class="voice-controls">
            <!-- ìŒì„± ì¸ì‹ ì œì–´ -->
            <div class="control-panel">
                <div class="panel-title">
                    <span>ğŸ¤</span>
                    ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹
                </div>
                
                <div class="permission-request" id="permissionRequest">
                    <h4>ğŸ”’ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h4>
                    <p>ìŒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë§ˆì´í¬ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>
                    <button class="voice-btn" onclick="requestMicrophonePermission()">
                        ğŸ¤ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                    </button>
                </div>

                <div class="voice-visualization" id="voiceVisualization">
                    <div class="voice-bars" id="voiceBars">
                        <!-- ìŒì„± ì‹œê°í™” ë°”ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecognition()">
                    ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘
                </button>
                
                <button class="voice-btn" onclick="toggleContinuousListening()">
                    ğŸ”„ ì—°ì† ìŒì„± ì¸ì‹
                </button>

                <div class="status-display">
                    <div><strong>ìŒì„± ìƒíƒœ:</strong> <span id="voiceStatus">ëŒ€ê¸° ì¤‘</span></div>
                    <div><strong>ì¸ì‹ëœ í…ìŠ¤íŠ¸:</strong> <span id="recognizedText">ì—†ìŒ</span></div>
                    <div><strong>ì‹ ë¢°ë„:</strong> <span id="confidence">0%</span></div>
                </div>
            </div>

            <!-- í•­ìƒ ëŒ€ê¸° ëª¨ë“œ -->
            <div class="control-panel">
                <div class="panel-title">
                    <span>ğŸ‘‚</span>
                    í•­ìƒ ëŒ€ê¸° ëª¨ë“œ
                </div>

                <div class="wake-word-settings">
                    <h4>ğŸ—£ï¸ ê¹¨ìš°ëŠ” ë§ ì„¤ì •</h4>
                    <p><strong>ê¸°ë³¸:</strong> "ì•ˆë…• ë¦¬ë‚˜", "í—¤ì´ ë¦¬ë‚˜"</p>
                    <p><strong>ì¶”ê°€:</strong> "ë¦¬ë‚˜ì•¼", "ë¦¬ë‚˜ ë„ì™€ì¤˜"</p>
                </div>

                <button class="voice-btn" id="alwaysListeningBtn" onclick="toggleAlwaysListening()">
                    ğŸ‘‚ í•­ìƒ ëŒ€ê¸° ëª¨ë“œ ì¼œê¸°
                </button>

                <div class="always-listening" id="alwaysListeningStatus" style="display: none;">
                    <h4>âœ… í•­ìƒ ëŒ€ê¸° ëª¨ë“œ í™œì„±í™”</h4>
                    <p>ì´ì œ ì–¸ì œë“ ì§€ "ì•ˆë…• ë¦¬ë‚˜"ë¼ê³  ë§í•˜ë©´ LYNAê°€ ì‘ë‹µí•©ë‹ˆë‹¤!</p>
                </div>

                <div class="status-display">
                    <div><strong>ëŒ€ê¸° ëª¨ë“œ:</strong> <span id="listeningModeStatus">ë¹„í™œì„±í™”</span></div>
                    <div><strong>ë§ˆì§€ë§‰ ëª…ë ¹:</strong> <span id="lastCommand">ì—†ìŒ</span></div>
                </div>
            </div>

            <!-- ì „í™” ì‹œìŠ¤í…œ -->
            <div class="control-panel">
                <div class="panel-title">
                    <span>ğŸ“</span>
                    LYNA ì „í™” ì‹œìŠ¤í…œ
                </div>

                <div class="phone-controls">
                    <button class="phone-btn" id="callBtn" onclick="startCall()">ğŸ“</button>
                    <button class="phone-btn" onclick="endCall()">ğŸ“µ</button>
                    <button class="phone-btn" onclick="muteCall()">ğŸ”‡</button>
                    <button class="phone-btn" onclick="speakerPhone()">ğŸ”Š</button>
                </div>

                <div class="status-display">
                    <div><strong>í†µí™” ìƒíƒœ:</strong> <span id="callStatus">ëŒ€ê¸° ì¤‘</span></div>
                    <div><strong>í†µí™” ì‹œê°„:</strong> <span id="callDuration">00:00</span></div>
                    <div><strong>ìŒì„± í’ˆì§ˆ:</strong> <span id="voiceQuality">ì–‘í˜¸</span></div>
                </div>
            </div>

            <!-- ìŒì„± í•©ì„± -->
            <div class="control-panel">
                <div class="panel-title">
                    <span>ğŸ—£ï¸</span>
                    LYNA ìŒì„± í•©ì„±
                </div>

                <button class="voice-btn" onclick="testVoiceSynthesis()">
                    ğŸ—£ï¸ LYNA ìŒì„± í…ŒìŠ¤íŠ¸
                </button>

                <button class="voice-btn" onclick="changeVoice()">
                    ğŸ­ ìŒì„± ë³€ê²½
                </button>

                <div class="status-display">
                    <div><strong>ìŒì„± íƒ€ì…:</strong> <span id="voiceType">ì—¬ì„± (í•œêµ­ì–´)</span></div>
                    <div><strong>ë§í•˜ê¸° ì†ë„:</strong> <span id="speechRate">ë³´í†µ</span></div>
                    <div><strong>ìŒì„± ë³¼ë¥¨:</strong> <span id="speechVolume">100%</span></div>
                </div>
            </div>
        </div>

        <div class="chat-container">
            <h3>ğŸ’¬ ìŒì„± + ì±„íŒ… í†µí•© ì¸í„°í˜ì´ìŠ¤</h3>
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <p>ğŸ¤ LYNA AI ìŒì„± ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                    <p>ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ê³  ìŒì„± ì¸ì‹ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="userInput" placeholder="í…ìŠ¤íŠ¸ ì…ë ¥ ë˜ëŠ” ìŒì„±ìœ¼ë¡œ ë§í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                <button class="voice-btn" onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let recognition = null;
        let isListening = false;
        let isAlwaysListening = false;
        let isContinuousListening = false;
        let isCallActive = false;
        let callStartTime = null;
        let speechSynthesis = window.speechSynthesis;
        let currentVoice = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;

        // ê¹¨ìš°ëŠ” ë§ ëª©ë¡
        const wakeWords = ['ì•ˆë…• ë¦¬ë‚˜', 'í—¤ì´ ë¦¬ë‚˜', 'ë¦¬ë‚˜ì•¼', 'ë¦¬ë‚˜ ë„ì™€ì¤˜', 'hey lyna', 'hi lyna'];

        // ìŒì„± ì‹œê°í™”ë¥¼ ìœ„í•œ ë°” ìƒì„±
        function createVoiceBars() {
            const voiceBars = document.getElementById('voiceBars');
            voiceBars.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'voice-bar';
                bar.style.height = '10px';
                voiceBars.appendChild(bar);
            }
        }

        // ìŒì„± ì‹œê°í™” ì—…ë°ì´íŠ¸
        function updateVoiceVisualization() {
            if (!analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);
            
            const bars = document.querySelectorAll('.voice-bar');
            const step = Math.floor(bufferLength / bars.length);
            
            bars.forEach((bar, index) => {
                const value = dataArray[index * step];
                const height = Math.max(10, (value / 255) * 60);
                bar.style.height = height + 'px';
            });
            
            if (isListening) {
                requestAnimationFrame(updateVoiceVisualization);
            }
        }

        // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                
                document.getElementById('permissionRequest').style.display = 'none';
                showNotification('âœ… ë§ˆì´í¬ ê¶Œí•œì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                initializeSpeechRecognition();
                
            } catch (error) {
                console.error('ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜:', error);
                showNotification('âŒ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ko-KR';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    isListening = true;
                    updateVoiceStatus('ìŒì„± ì¸ì‹ ì¤‘...');
                    document.getElementById('voiceBtn').textContent = 'ğŸ”´ ì¸ì‹ ì¤‘ì§€';
                    document.getElementById('voiceBtn').classList.add('active');
                    document.getElementById('floatingVoiceBtn').classList.add('listening');
                    updateVoiceVisualization();
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        const confidence = event.results[i][0].confidence;
                        
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                            document.getElementById('confidence').textContent = Math.round(confidence * 100) + '%';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    document.getElementById('recognizedText').textContent = finalTranscript || interimTranscript;
                    
                    if (finalTranscript) {
                        processVoiceCommand(finalTranscript);
                        
                        if (!isContinuousListening && !isAlwaysListening) {
                            stopVoiceRecognition();
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    updateVoiceStatus('ì˜¤ë¥˜: ' + event.error);
                    showNotification('ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                };

                recognition.onend = function() {
                    if (isAlwaysListening || isContinuousListening) {
                        // í•­ìƒ ëŒ€ê¸° ëª¨ë“œë‚˜ ì—°ì† ì¸ì‹ ëª¨ë“œì—ì„œëŠ” ìë™ ì¬ì‹œì‘
                        setTimeout(() => {
                            if (isAlwaysListening || isContinuousListening) {
                                recognition.start();
                            }
                        }, 100);
                    } else {
                        stopVoiceRecognition();
                    }
                };

                addMessage('ğŸ¤ ìŒì„± ì¸ì‹ ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'ai');
                
            } else {
                showNotification('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìŒì„± ì¸ì‹ í† ê¸€
        function toggleVoiceRecognition() {
            if (!recognition) {
                showNotification('ë¨¼ì € ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }

            if (isListening) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        }

        // ìŒì„± ì¸ì‹ ì‹œì‘
        function startVoiceRecognition() {
            if (!recognition) return;
            
            try {
                recognition.start();
                showVoiceInterface();
            } catch (error) {
                console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', error);
            }
        }

        // ìŒì„± ì¸ì‹ ì¤‘ì§€
        function stopVoiceRecognition() {
            if (recognition && isListening) {
                recognition.stop();
                isListening = false;
                updateVoiceStatus('ëŒ€ê¸° ì¤‘');
                document.getElementById('voiceBtn').textContent = 'ğŸ¤ ìŒì„± ì¸ì‹ ì‹œì‘';
                document.getElementById('voiceBtn').classList.remove('active');
                document.getElementById('floatingVoiceBtn').classList.remove('listening');
                hideVoiceInterface();
            }
        }

        // ì—°ì† ìŒì„± ì¸ì‹ í† ê¸€
        function toggleContinuousListening() {
            isContinuousListening = !isContinuousListening;
            
            if (isContinuousListening) {
                startVoiceRecognition();
                showNotification('ğŸ”„ ì—°ì† ìŒì„± ì¸ì‹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                stopVoiceRecognition();
                showNotification('ğŸ”„ ì—°ì† ìŒì„± ì¸ì‹ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // í•­ìƒ ëŒ€ê¸° ëª¨ë“œ í† ê¸€
        function toggleAlwaysListening() {
            if (!recognition) {
                showNotification('ë¨¼ì € ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }

            isAlwaysListening = !isAlwaysListening;
            
            const statusElement = document.getElementById('alwaysListeningStatus');
            const btnElement = document.getElementById('alwaysListeningBtn');
            const modeStatus = document.getElementById('listeningModeStatus');
            
            if (isAlwaysListening) {
                startVoiceRecognition();
                statusElement.style.display = 'block';
                btnElement.textContent = 'ğŸ‘‚ í•­ìƒ ëŒ€ê¸° ëª¨ë“œ ë„ê¸°';
                btnElement.classList.add('active');
                modeStatus.textContent = 'í™œì„±í™” - ëŒ€ê¸° ì¤‘';
                showNotification('ğŸ‘‚ í•­ìƒ ëŒ€ê¸° ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤! "ì•ˆë…• ë¦¬ë‚˜"ë¼ê³  ë§í•´ë³´ì„¸ìš”.', 'success');
                addMessage('ğŸ‘‚ LYNAê°€ í•­ìƒ ëŒ€ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì–¸ì œë“ ì§€ "ì•ˆë…• ë¦¬ë‚˜"ë¼ê³  ë¶€ë¥´ì„¸ìš”!', 'ai');
            } else {
                stopVoiceRecognition();
                statusElement.style.display = 'none';
                btnElement.textContent = 'ğŸ‘‚ í•­ìƒ ëŒ€ê¸° ëª¨ë“œ ì¼œê¸°';
                btnElement.classList.remove('active');
                modeStatus.textContent = 'ë¹„í™œì„±í™”';
                showNotification('ğŸ‘‚ í•­ìƒ ëŒ€ê¸° ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // í”Œë¡œíŒ… ìŒì„± ì–´ì‹œìŠ¤í„´íŠ¸ í† ê¸€
        function toggleVoiceAssistant() {
            if (!recognition) {
                requestMicrophonePermission();
                return;
            }

            if (isListening) {
                stopVoiceRecognition();
            } else {
                startVoiceRecognition();
            }
        }

        // ìŒì„± ì¸í„°í˜ì´ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€
        function showVoiceInterface() {
            document.getElementById('voiceOverlay').style.display = 'flex';
        }

        function hideVoiceInterface() {
            document.getElementById('voiceOverlay').style.display = 'none';
        }

        // ìŒì„± ëª…ë ¹ ì²˜ë¦¬
        function processVoiceCommand(command) {
            const lowerCommand = command.toLowerCase().trim();
            document.getElementById('lastCommand').textContent = command;
            
            // ê¹¨ìš°ëŠ” ë§ ê°ì§€
            const isWakeWord = wakeWords.some(wake => lowerCommand.includes(wake.toLowerCase()));
            
            if (isWakeWord) {
                handleWakeWord(lowerCommand);
                return;
            }
            
            // ì¼ë°˜ ìŒì„± ëª…ë ¹ ì²˜ë¦¬
            if (isListening || isAlwaysListening) {
                addMessage(`ğŸ¤ ìŒì„±: ${command}`, 'voice');
                
                // ëª…ë ¹ì–´ë³„ ì²˜ë¦¬
                if (lowerCommand.includes('ì „í™”') || lowerCommand.includes('í†µí™”')) {
                    if (lowerCommand.includes('ê±¸ì–´') || lowerCommand.includes('ì‹œì‘')) {
                        startCall();
                        speakResponse('ì „í™”ë¥¼ ê±¸ê³  ìˆìŠµë‹ˆë‹¤.');
                    } else if (lowerCommand.includes('ëŠì–´') || lowerCommand.includes('ì¢…ë£Œ')) {
                        endCall();
                        speakResponse('ì „í™”ë¥¼ ëŠì—ˆìŠµë‹ˆë‹¤.');
                    }
                } else if (lowerCommand.includes('ìŒì†Œê±°') || lowerCommand.includes('ë¬´ìŒ')) {
                    muteCall();
                    speakResponse('ìŒì†Œê±° ì„¤ì •í–ˆìŠµë‹ˆë‹¤.');
                } else if (lowerCommand.includes('ìŠ¤í”¼ì»¤') || lowerCommand.includes('í™•ì„±ê¸°')) {
                    speakerPhone();
                    speakResponse('ìŠ¤í”¼ì»¤í°ìœ¼ë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤.');
                } else if (lowerCommand.includes('ì•ˆë…•') || lowerCommand.includes('ì¸ì‚¬')) {
                    speakResponse('ì•ˆë…•í•˜ì„¸ìš”! LYNA AIì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?');
                } else if (lowerCommand.includes('ì‹œê°„') || lowerCommand.includes('ëª‡ì‹œ')) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('ko-KR');
                    speakResponse(`í˜„ì¬ ì‹œê°„ì€ ${timeString}ì…ë‹ˆë‹¤.`);
                } else if (lowerCommand.includes('ì¢…ë£Œ') || lowerCommand.includes('ê·¸ë§Œ')) {
                    stopVoiceRecognition();
                    speakResponse('ìŒì„± ì¸ì‹ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.');
                } else {
                    // ì¼ë°˜ AI ì‘ë‹µ
                    const response = generateAIResponse(command);
                    addMessage(response, 'ai');
                    speakResponse(response);
                }
            }
        }

        // ê¹¨ìš°ëŠ” ë§ ì²˜ë¦¬
        function handleWakeWord(command) {
            if (isAlwaysListening) {
                const responses = [
                    'ë„¤, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?',
                    'ì•ˆë…•í•˜ì„¸ìš”! LYNAì…ë‹ˆë‹¤.',
                    'ë„¤, ë“£ê³  ìˆì–´ìš”. ë§ì”€í•˜ì„¸ìš”.',
                    'ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”!'
                ];
                
                const response = responses[Math.floor(Math.random() * responses.length)];
                addMessage(`ğŸ‘‚ ê¹¨ìš°ëŠ” ë§ ê°ì§€: ${command}`, 'voice');
                addMessage(`ğŸ—£ï¸ LYNA: ${response}`, 'ai');
                speakResponse(response);
                
                // ì ì‹œ í›„ ëª…ë ¹ ëŒ€ê¸°
                setTimeout(() => {
                    updateVoiceStatus('ëª…ë ¹ ëŒ€ê¸° ì¤‘...');
                }, 1000);
            }
        }

        // ìŒì„± ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateVoiceStatus(status) {
            document.getElementById('voiceStatus').textContent = status;
            document.getElementById('voiceStatusText').textContent = status;
        }

        // ì „í™” ê¸°ëŠ¥ë“¤
        function startCall() {
            if (isCallActive) {
                showNotification('ì´ë¯¸ í†µí™” ì¤‘ì…ë‹ˆë‹¤.', 'info');
                return;
            }

            isCallActive = true;
            callStartTime = Date.now();
            
            document.getElementById('callBtn').classList.add('calling');
            document.getElementById('floatingPhoneBtn').classList.add('calling');
            document.getElementById('callStatus').textContent = 'LYNA AI ì—°ê²° ì¤‘...';
            
            showNotification('ğŸ“ LYNA AIì™€ ìŒì„± í†µí™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            setTimeout(() => {
                document.getElementById('callStatus').textContent = 'âœ… LYNA AIì™€ ì—°ê²°ë¨';
                addMessage('ğŸ“ LYNA AI ìŒì„± í†µí™”ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'ai');
                speakResponse('ì•ˆë…•í•˜ì„¸ìš”! LYNA AI ìŒì„± í†µí™”ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. í¸í•˜ê²Œ ëŒ€í™”í•˜ì„¸ìš”.');
                
                // í†µí™” ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œì‘
                updateCallDuration();
            }, 2000);
        }

        function endCall() {
            if (!isCallActive) {
                showNotification('í˜„ì¬ í†µí™” ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.', 'info');
                return;
            }

            isCallActive = false;
            callStartTime = null;
            
            document.getElementById('callBtn').classList.remove('calling');
            document.getElementById('floatingPhoneBtn').classList.remove('calling');
            document.getElementById('callStatus').textContent = 'ğŸ“µ í†µí™” ì¢…ë£Œë¨';
            document.getElementById('callDuration').textContent = '00:00';
            
            addMessage('ğŸ“µ LYNA AI ìŒì„± í†µí™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'ai');
            speakResponse('í†µí™”ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.');
            showNotification('ğŸ“µ í†µí™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        function muteCall() {
            if (!isCallActive) {
                showNotification('í†µí™” ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.', 'info');
                return;
            }
            
            addMessage('ğŸ”‡ ë§ˆì´í¬ê°€ ìŒì†Œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ai');
            showNotification('ğŸ”‡ ìŒì†Œê±° ì„¤ì •', 'info');
        }

        function speakerPhone() {
            if (!isCallActive) {
                showNotification('í†µí™” ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.', 'info');
                return;
            }
            
            addMessage('ğŸ”Š ìŠ¤í”¼ì»¤í°ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ai');
            showNotification('ğŸ”Š ìŠ¤í”¼ì»¤í° í™œì„±í™”', 'info');
        }

        // í”Œë¡œíŒ… ì „í™” ë²„íŠ¼ í† ê¸€
        function togglePhoneCall() {
            if (isCallActive) {
                endCall();
            } else {
                startCall();
            }
        }

        // í†µí™” ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateCallDuration() {
            if (!isCallActive || !callStartTime) return;
            
            const duration = Date.now() - callStartTime;
            const minutes = Math.floor(duration / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            document.getElementById('callDuration').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (isCallActive) {
                setTimeout(updateCallDuration, 1000);
            }
        }

        // ìŒì„± í•©ì„± ê¸°ëŠ¥
        function initializeVoiceSynthesis() {
            const voices = speechSynthesis.getVoices();
            
            // í•œêµ­ì–´ ìŒì„± ì°¾ê¸°
            currentVoice = voices.find(voice => 
                voice.lang.includes('ko') && voice.name.includes('Female')
            ) || voices.find(voice => voice.lang.includes('ko')) || voices[0];
            
            if (currentVoice) {
                document.getElementById('voiceType').textContent = 
                    `${currentVoice.name} (${currentVoice.lang})`;
            }
        }

        function speakResponse(text) {
            if (!speechSynthesis) return;
            
            // ê¸°ì¡´ ìŒì„± ì¤‘ì§€
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = currentVoice;
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = function() {
                updateVoiceStatus('LYNA ì‘ë‹µ ì¤‘...');
            };
            
            utterance.onend = function() {
                updateVoiceStatus(isListening ? 'ìŒì„± ì¸ì‹ ì¤‘...' : 'ëŒ€ê¸° ì¤‘');
            };
            
            speechSynthesis.speak(utterance);
        }

        function testVoiceSynthesis() {
            speakResponse('ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” LYNA AIì…ë‹ˆë‹¤. ìŒì„± í•©ì„± ê¸°ëŠ¥ì´ ì •ìƒ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.');
        }

        function changeVoice() {
            const voices = speechSynthesis.getVoices();
            const koreanVoices = voices.filter(voice => voice.lang.includes('ko'));
            
            if (koreanVoices.length > 1) {
                const currentIndex = koreanVoices.indexOf(currentVoice);
                const nextIndex = (currentIndex + 1) % koreanVoices.length;
                currentVoice = koreanVoices[nextIndex];
                
                document.getElementById('voiceType').textContent = 
                    `${currentVoice.name} (${currentVoice.lang})`;
                
                speakResponse('ìŒì„±ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                showNotification('ğŸ­ ìŒì„±ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showNotification('ì‚¬ìš© ê°€ëŠ¥í•œ ë‹¤ë¥¸ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
            }
        }

        // AI ì‘ë‹µ ìƒì„±
        function generateAIResponse(message) {
            const responses = [
                'ë„¤, ì˜ ë“¤ì—ˆìŠµë‹ˆë‹¤. ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì‹œê² ì–´ìš”?',
                'í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”! ì œê°€ ë„ì™€ë“œë¦´ê²Œìš”.',
                'ìŒì„±ìœ¼ë¡œ ë§ì”€í•´ì£¼ì…”ì„œ ë” ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”.',
                'LYNA AIê°€ ìŒì„± ëª…ë ¹ì„ ì •í™•íˆ ì´í•´í–ˆìŠµë‹ˆë‹¤.',
                'ë„¤, ë¬´ì—‡ì´ë“  ë” ë¬¼ì–´ë³´ì„¸ìš”!'
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (message === '') return;
            
            addMessage(message, 'user');
            userInput.value = '';
            
            setTimeout(() => {
                const response = generateAIResponse(message);
                addMessage(response, 'ai');
                speakResponse(response);
            }, 1000);
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(text, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 2rem;
                border-radius: 10px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.5s ease-out;
            `;
            
            if (type === 'success') notification.style.background = '#4caf50';
            else if (type === 'error') notification.style.background = '#f44336';
            else notification.style.background = '#2196f3';
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeSystem() {
            // ìŒì„± ì‹œê°í™” ë°” ìƒì„±
            createVoiceBars();
            
            // ìŒì„± í•©ì„± ì´ˆê¸°í™”
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = initializeVoiceSynthesis;
            } else {
                initializeVoiceSynthesis();
            }
            
            // í™˜ì˜ ë©”ì‹œì§€
            setTimeout(() => {
                addMessage('ğŸ¤ LYNA AI ìŒì„± ì‹œìŠ¤í…œì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•˜ê³  ìŒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.', 'ai');
                speakResponse('LYNA AI ìŒì„± ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 1000);
            
            // ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤
            document.getElementById('userInput').focus();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', initializeSystem);

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(event) {
            // Spacebarë¡œ ìŒì„± ì¸ì‹ í† ê¸€ (Shift + Space)
            if (event.shiftKey && event.code === 'Space') {
                event.preventDefault();
                toggleVoiceAssistant();
            }
            
            // Ctrl + Pë¡œ ì „í™” í† ê¸€
            if (event.ctrlKey && event.key === 'p') {
                event.preventDefault();
                togglePhoneCall();
            }
            
            // Ctrl + Lë¡œ í•­ìƒ ëŒ€ê¸° ëª¨ë“œ í† ê¸€
            if (event.ctrlKey && event.key === 'l') {
                event.preventDefault();
                toggleAlwaysListening();
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (recognition && isListening) {
                recognition.stop();
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });

        // ìë™ ê¶Œí•œ ìš”ì²­ (3ì´ˆ í›„)
        setTimeout(() => {
            if (!recognition) {
                showNotification('ğŸ¤ ìŒì„± ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!', 'info');
            }
        }, 3000);
    </script>
</body>
</html>
