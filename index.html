import os
import time
from playwright.sync_api import sync_playwright
from datetime import datetime

UPLOAD_DIR = "upload_queue"

def read_file(filepath):
    with open(filepath, "r", encoding="utf-8") as f:
        return f.read().strip()

def upload_video(playwright, video_id):
    browser = playwright.chromium.launch(headless=False)
    context = browser.new_context(storage_state="auth.json")  # 로그인 저장
    page = context.new_page()

    page.goto("https://studio.youtube.com")

    page.wait_for_timeout(5000)
    page.goto("https://studio.youtube.com/channel/UC/videos/upload")

    # 파일 업로드
    video_path = f"{UPLOAD_DIR}/{video_id}_video.mp4"
    page.set_input_files('input[type="file"]', video_path)

    # 제목 입력
    title = read_file(f"{UPLOAD_DIR}/{video_id}_title.txt")
    page.get_by_label("Title").fill(title)

    # 설명 입력
    description = read_file(f"{UPLOAD_DIR}/{video_id}_description.txt")
    page.get_by_label("Description").fill(description)

    # 썸네일 업로드
    thumb_path = f"{UPLOAD_DIR}/{video_id}_thumbnail.jpg"
    if os.path.exists(thumb_path):
        page.get_by_text("Upload thumbnail").click()
        page.set_input_files('input[type="file"]', thumb_path)

    # 다음 버튼 3번 클릭
    for _ in range(3):
        page.get_by_text("Next").click()
        page.wait_for_timeout(1000)

    # 예약 게시 설정
    page.get_by_text("Schedule").click()

    schedule = read_file(f"{UPLOAD_DIR}/{video_id}_schedule.txt")
    dt = datetime.strptime(schedule, "%Y-%m-%d %H:%M")

    page.get_by_label("Date").fill(dt.strftime("%m/%d/%Y"))
    page.get_by_label("Time").fill(dt.strftime("%I:%M %p"))

    page.get_by_text("Schedule").nth(1).click()

    print(f"{video_id} 예약 업로드 완료 ✅")
    page.wait_for_timeout(3000)
    context.close()
    browser.close()

def main():
    with sync_playwright() as p:
        for file in os.listdir(UPLOAD_DIR):
            if file.endswith("_video.mp4"):
                video_id = file.split("_")[0]
                try:
                    upload_video(p, video_id)
                except Exception as e:
                    print(f"{video_id} 실패 ❌: {e}")

if __name__ == "__main__":
    main()
