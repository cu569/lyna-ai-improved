# 🎬 간단하지만 강력한 YouTube 자동화 시스템
# 즉시 실행 가능한 핵심 버전

import os
import asyncio
import json
import logging
from datetime import datetime
from typing import Dict, List, Optional
from dataclasses import dataclass

# 환경 설정
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')
logger = logging.getLogger(__name__)

@dataclass
class SimpleVideoProject:
    """간단한 비디오 프로젝트"""
    title: str
    description: str
    tags: List[str]
    script: str = ""
    created_at: datetime = None
    
    def __post_init__(self):
        if self.created_at is None:
            self.created_at = datetime.now()

class SimpleYouTubeAutomation:
    """간단한 YouTube 자동화 시스템"""
    
    def __init__(self, openai_key: str = None):
        self.openai_key = openai_key or os.getenv('OPENAI_API_KEY')
        self.projects = []
        
        # 기본 설정
        self.settings = {
            'default_duration': 5,
            'default_audience': '일반',
            'auto_save': True
        }
        
        # 디렉토리 생성
        os.makedirs('simple_projects', exist_ok=True)
        
        print("🎬 간단 YouTube 자동화 시스템 준비 완료!")
    
    async def create_quick_project(self, topic: str, custom_title: str = None) -> SimpleVideoProject:
        """빠른 프로젝트 생성 (GPT 없이도 작동)"""
        
        print(f"📹 '{topic}' 프로젝트 생성 중...")
        
        # 1. 제목 생성
        if custom_title:
            title = custom_title
        else:
            title_templates = [
                f"{topic}에 대한 완벽 가이드",
                f"{topic} 초보자를 위한 필수 정보",
                f"{topic} 전문가가 알려주는 비밀",
                f"{topic}로 성공하는 확실한 방법",
                f"{topic} 완전 정복하기"
            ]
            import random
            title = random.choice(title_templates)
        
        # 2. 설명 생성
        description = self._generate_description(topic, title)
        
        # 3. 태그 생성
        tags = self._generate_tags(topic)
        
        # 4. 스크립트 생성
        script = self._generate_script(title, topic)
        
        # 5. 프로젝트 생성
        project = SimpleVideoProject(
            title=title,
            description=description,
            tags=tags,
            script=script
        )
        
        # 6. 저장
        if self.settings['auto_save']:
            self._save_project(project)
        
        self.projects.append(project)
        
        print(f"✅ 프로젝트 생성 완료: {title}")
        return project
    
    def _generate_description(self, topic: str, title: str) -> str:
        """설명 자동 생성"""
        
        description_parts = [
            f"안녕하세요! 오늘은 {topic}에 대해 자세히 알아보겠습니다.",
            "",
            f"🎯 이 영상에서 배울 수 있는 것:",
            f"✅ {topic}의 핵심 개념",
            f"✅ 실제 활용 방법", 
            f"✅ 전문가 팁과 노하우",
            f"✅ 자주 묻는 질문들",
            "",
            "📋 타임스탬프:",
            "00:00 인트로",
            "00:30 핵심 내용",
            "04:00 실습 및 예시",
            "04:30 마무리",
            "",
            "👍 이 영상이 도움되셨다면 좋아요와 구독 부탁드립니다!",
            "🔔 알림 설정을 켜서 새로운 영상을 가장 먼저 받아보세요!",
            "💬 궁금한 점이나 의견은 댓글로 남겨주세요!",
            "",
            f"#{topic.replace(' ', '')} #유튜브 #정보 #가이드 #팁",
            "",
            "📧 문의: contact@example.com"
        ]
        
        return "\n".join(description_parts)
    
    def _generate_tags(self, topic: str) -> List[str]:
        """태그 자동 생성"""
        
        # 기본 태그
        basic_tags = [topic, '유튜브', '가이드', '정보', '팁', '방법']
        
        # 주제별 추가 태그
        topic_tags = {
            'AI': ['인공지능', '머신러닝', '자동화', '기술'],
            '투자': ['재테크', '경제', '주식', '부동산', '금융'],
            '유튜브': ['크리에이터', '마케팅', '콘텐츠', '조회수'],
            '요리': ['레시피', '음식', '맛집', '건강'],
            '운동': ['헬스', '다이어트', '건강', '피트니스'],
            '개발': ['프로그래밍', 'IT', '코딩', '기술'],
            '부동산': ['투자', '경제', '재테크', '금융']
        }
        
        # 주제 관련 태그 추가
        for key, values in topic_tags.items():
            if key.lower() in topic.lower():
                basic_tags.extend(values)
                break
        
        # 일반적인 인기 태그 추가
        popular_tags = ['2024', '최신', '완벽', '초보자', '전문가', '꿀팁']
        basic_tags.extend(popular_tags)
        
        # 중복 제거 및 최대 15개 제한
        unique_tags = list(dict.fromkeys(basic_tags))
        return unique_tags[:15]
    
    def _generate_script(self, title: str, topic: str) -> str:
        """스크립트 자동 생성"""
        
        script_template = f"""
[0:00] 안녕하세요! 오늘은 "{title}"에 대해 이야기해보겠습니다.

[0:15] 이 영상을 끝까지 보시면 {topic}에 대해 확실히 이해하실 수 있을 거예요.

[0:30] 그럼 바로 시작해볼까요?

=== 메인 콘텐츠 ===

[1:00] 첫 번째로 알아볼 내용은 {topic}의 기본 개념입니다.

[1:30] {topic}를 처음 접하시는 분들을 위해 쉽게 설명드릴게요.

[2:00] 많은 분들이 궁금해하시는 부분이 바로 이것인데요...

[2:30] 실제로 어떻게 적용할 수 있는지 구체적인 예시를 들어보겠습니다.

[3:00] 여기서 중요한 포인트는...

[3:30] 초보자들이 자주 실수하는 부분도 함께 알아보겠습니다.

[4:00] 지금까지 {topic}에 대해 알아보았는데요.

[4:15] 오늘 내용이 도움이 되셨다면 좋아요와 구독 부탁드립니다!

[4:30] 다음 영상에서 더 유용한 내용으로 찾아뵙겠습니다. 감사합니다!

=== 추가 팁 ===
• 시청자와의 소통: "여러분은 어떻게 생각하시나요?"
• 참여 유도: "댓글로 의견을 남겨주세요!"
• 구독 유도: "구독과 알림 설정 잊지 마세요!"
"""
        
        return script_template.strip()
    
    def _save_project(self, project: SimpleVideoProject):
        """프로젝트 저장"""
        
        # 안전한 파일명 생성
        safe_title = "".join(c for c in project.title if c.isalnum() or c in (' ', '-', '_')).strip()[:30]
        timestamp = project.created_at.strftime('%Y%m%d_%H%M%S')
        filename = f"simple_projects/{timestamp}_{safe_title}.json"
        
        # 프로젝트 데이터
        project_data = {
            'title': project.title,
            'description': project.description,
            'tags': project.tags,
            'script': project.script,
            'created_at': project.created_at.isoformat(),
            'settings_used': self.settings.copy()
        }
        
        # JSON 파일로 저장
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(project_data, f, ensure_ascii=False, indent=2)
        
        # 스크립트 별도 저장
        script_filename = filename.replace('.json', '_script.txt')
        with open(script_filename, 'w', encoding='utf-8') as f:
            f.write(project.script)
        
        logger.info(f"📁 프로젝트 저장: {filename}")
    
    async def bulk_create(self, topics: List[str]) -> List[SimpleVideoProject]:
        """대량 프로젝트 생성"""
        
        print(f"🚀 {len(topics)}개 주제로 대량 생성 시작!")
        
        projects = []
        for i, topic in enumerate(topics, 1):
            print(f"\n[{i}/{len(topics)}] 처리 중: {topic}")
            
            try:
                project = await self.create_quick_project(topic)
                projects.append(project)
                print(f"✅ 완료: {project.title}")
                
                # 너무 빠르게 처리하지 않도록 잠시 대기
                await asyncio.sleep(0.5)
                
            except Exception as e:
                print(f"❌ 실패: {topic} - {e}")
        
        print(f"\n🎉 대량 생성 완료! 총 {len(projects)}개 프로젝트")
        return projects
    
    def get_project_summary(self) -> Dict:
        """프로젝트 요약"""
        
        if not self.projects:
            return {'message': '생성된 프로젝트가 없습니다.'}
        
        return {
            'total_projects': len(self.projects),
            'recent_projects': [
                {
                    'title': p.title,
                    'tags_count': len(p.tags),
                    'script_length': len(p.script),
                    'created_at': p.created_at.strftime('%Y-%m-%d %H:%M')
                }
                for p in self.projects[-5:]  # 최근 5개
            ],
            'total_tags': sum(len(p.tags) for p in self.projects),
            'avg_script_length': sum(len(p.script) for p in self.projects) // len(self.projects)
        }
    
    def print_project_details(self, project: SimpleVideoProject):
        """프로젝트 상세 정보 출력"""
        
        print("\n" + "="*60)
        print("📋 프로젝트 상세 정보")
        print("="*60)
        print(f"📹 제목: {project.title}")
        print(f"🏷️ 태그: {', '.join(project.tags[:8])}{'...' if len(project.tags) > 8 else ''}")
        print(f"📝 설명 길이: {len(project.description)}자")
        print(f"📜 스크립트 길이: {len(project.script)}자") 
        print(f"📅 생성 시간: {project.created_at.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"💾 저장됨: simple_projects/ 폴더")

# GPT 연동 기능 (선택적)
class GPTEnhancer:
    """GPT로 콘텐츠 품질 향상 (선택 사항)"""
    
    def __init__(self, api_key: str):
        self.api_key = api_key
        try:
            import openai
            self.client = openai.OpenAI(api_key=api_key)
            self.available = True
        except ImportError:
            print("⚠️ OpenAI 패키지가 없습니다. 기본 생성 모드로 작동합니다.")
            self.available = False
    
    async def enhance_title(self, topic: str) -> str:
        """제목 개선"""
        if not self.available:
            return f"{topic}에 대한 완벽 가이드"
        
        try:
            response = await self.client.chat.completions.acreate(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "user", "content": f"'{topic}' 주제로 클릭률이 높은 유튜브 제목 1개를 50자 이내로 만들어주세요."}
                ],
                max_tokens=100
            )
            return response.choices[0].message.content.strip()
        except:
            return f"{topic} - 전문가가 알려주는 비밀"

# 사용 예시 및 실행 함수
async def demo_simple_automation():
    """간단한 자동화 시스템 데모"""
    
    print("🎬 간단 YouTube 자동화 시스템 데모")
    print("="*50)
    
    # 시스템 초기화
    automation = SimpleYouTubeAutomation()
    
    # 1. 단일 프로젝트 생성
    print("\n1️⃣ 단일 프로젝트 생성 테스트")
    project1 = await automation.create_quick_project("AI 투자 전략")
    automation.print_project_details(project1)
    
    # 2. 사용자 정의 제목으로 생성
    print("\n2️⃣ 사용자 정의 제목 프로젝트")
    project2 = await automation.create_quick_project(
        topic="부동산 투자", 
        custom_title="2024년 부동산 투자 대박나는 3가지 비법"
    )
    automation.print_project_details(project2)
    
    # 3. 대량 생성
    print("\n3️⃣ 대량 프로젝트 생성 테스트")
    topics = ["유튜브 마케팅", "주식 투자", "파이썬 프로그래밍", "영어 회화"]
    bulk_projects = await automation.bulk_create(topics)
    
    # 4. 요약 정보
    print("\n4️⃣ 전체 프로젝트 요약")
    summary = automation.get_project_summary()
    print(json.dumps(summary, ensure_ascii=False, indent=2))
    
    print(f"\n🎉 데모 완료! 총 {len(automation.projects)}개 프로젝트 생성됨")
    print(f"📁 파일 위치: simple_projects/ 폴더 확인")

# 대화형 실행 함수
async def interactive_mode():
    """대화형 모드"""
    
    print("🎬 대화형 YouTube 프로젝트 생성기")
    print("="*50)
    
    automation = SimpleYouTubeAutomation()
    
    while True:
        print("\n📋 메뉴:")
        print("1. 단일 프로젝트 생성")
        print("2. 대량 프로젝트 생성") 
        print("3. 프로젝트 요약 보기")
        print("4. 종료")
        
        choice = input("\n선택 (1-4): ").strip()
        
        try:
            if choice == "1":
                topic = input("📝 주제를 입력하세요: ").strip()
                if topic:
                    custom_title = input("✏️ 사용자 정의 제목 (엔터로 건너뛰기): ").strip()
                    project = await automation.create_quick_project(
                        topic, 
                        custom_title if custom_title else None
                    )
                    automation.print_project_details(project)
                
            elif choice == "2":
                topics_input = input("📝 주제들을 쉼표로 구분해서 입력하세요: ").strip()
                if topics_input:
                    topics = [t.strip() for t in topics_input.split(',') if t.strip()]
                    await automation.bulk_create(topics)
                
            elif choice == "3":
                summary = automation.get_project_summary()
                print(json.dumps(summary, ensure_ascii=False, indent=2))
                
            elif choice == "4":
                print("👋 시스템을 종료합니다.")
                break
                
            else:
                print("❌ 잘못된 선택입니다.")
                
        except KeyboardInterrupt:
            print("\n👋 시스템을 종료합니다.")
            break
        except Exception as e:
            print(f"❌ 오류: {e}")

# 메인 실행
if __name__ == "__main__":
    print("🚀 즉시 실행 가능한 YouTube 자동화 시스템")
    print("="*60)
    print("선택하세요:")
    print("1. 데모 실행")
    print("2. 대화형 모드")
    
    choice = input("\n선택 (1-2): ").strip()
    
    try:
        if choice == "1":
            asyncio.run(demo_simple_automation())
        elif choice == "2":
            asyncio.run(interactive_mode())
        else:
            print("❌ 잘못된 선택입니다.")
    except KeyboardInterrupt:
        print("\n👋 프로그램을 종료합니다.")
